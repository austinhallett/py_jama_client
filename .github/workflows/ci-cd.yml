name: Publish Python ğŸ distribution ğŸ“¦ to PyPI and TestPyPI

on:
    push:
        branches:
            - "**"
        tags:
            - "*"

jobs:
    lint:
        name: Lint the Python ğŸ code
        runs-on: ubuntu-latest
        steps:
            - &checkout
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
            - &setup-python
              name: Set up Python
              uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
              with:
                  python-version: "3.x"
                  cache: "pip"

            - name: Install ruff
              run: python3 -m pip install ruff

            - name: Lint the Python ğŸ code
              run: python3 -m ruff check
    build:
        if: startsWith(github.ref, 'refs/tags/')
        needs: [lint]
        name: Build distribution ğŸ“¦
        runs-on: ubuntu-latest
        steps:
            - *checkout
            - *setup-python
            - name: Install pypa/build
              run: >-
                  python3 -m pip install
                  --user build hatchling
            - name: Version the package
              run: >-
                  python3 -m hatchling
                  version ${{ github.ref_name }}
            - name: Build a binary wheel and a source tarball
              run: python3 -m build
            - name: Store the distribution packages
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: python-package-distributions
                  path: dist/

    publish-to-pypi:
        name: >-
            Publish Python ğŸ distribution ğŸ“¦ to PyPI
        if: startsWith(github.ref, 'refs/tags/') # only publish to PyPI on tag pushes
        needs:
            - build
        runs-on: ubuntu-latest
        environment:
            name: pypi
            url: https://pypi.org/p/py_jama_client
        permissions:
            id-token: write # IMPORTANT: mandatory for trusted publishing

        steps:
            - &download-dists
              name: Download all the dists
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
              with:
                  name: python-package-distributions
                  path: dist/
            - name: Publish distribution ğŸ“¦ to PyPI
              uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0

    github-release:
        name: >-
            Sign the Python ğŸ distribution ğŸ“¦ with Sigstore
            and upload them to GitHub Release
        needs:
            - publish-to-pypi
        runs-on: ubuntu-latest

        permissions:
            contents: write # IMPORTANT: mandatory for making GitHub Releases
            id-token: write # IMPORTANT: mandatory for sigstore

        steps:
            - *download-dists
            - name: Sign the dists with Sigstore
              uses: sigstore/gh-action-sigstore-python@v3.2.0
              with:
                  inputs: >-
                      ./dist/*.tar.gz
                      ./dist/*.whl
            - name: Create GitHub Release
              env:
                  GITHUB_TOKEN: ${{ github.token }}
              run: >-
                  gh release create
                  '${{ github.ref_name }}'
                  --repo '${{ github.repository }}'
                  --generate-notes

            - name: Upload artifact signatures to GitHub Release
              env:
                  GITHUB_TOKEN: ${{ github.token }}
              # Upload to GitHub Release using the `gh` CLI.
              # `dist/` contains the built packages, and the
              # sigstore-produced signatures and certificates.
              run: >-
                  gh release upload
                  '${{ github.ref_name }}' dist/**
                  --repo '${{ github.repository }}'

    publish-to-testpypi:
        if: startsWith(github.ref, 'refs/tags/')
        name: Publish Python ğŸ distribution ğŸ“¦ to TestPyPI
        needs:
            - build
        runs-on: ubuntu-latest

        environment:
            name: testpypi
            url: https://test.pypi.org/p/py_jama_client

        permissions:
            id-token: write # IMPORTANT: mandatory for trusted publishing

        steps:
            - *download-dists
            - name: Publish distribution ğŸ“¦ to TestPyPI
              uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
              with:
                  repository-url: https://test.pypi.org/legacy/
